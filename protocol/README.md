# Protocol

This document describes the canonical system architecture used to encrypt and decrypt TDF ciphertext.

## Architecture

The canonical architecture contains four major components.

* *TDF Client* - Initiates and drives the TDF encryption and decryption workflows. Only component with access to the content (ciphertext or plaintext).
* *OpenID Connect (OIDC) Identity Provider (IdP)* - This system could be any OIDC IdP software.  Virtru has chosen Keycloak as our reference implementation IdP.
  * From Wikipedia:  "Keycloak is an open source software product to allow single sign-on with Identity and Access Management aimed at modern applications and services. As of March 2018 this JBoss community project is under the stewardship of Red Hat who use it as the upstream project for their RH-SSO product."  Keycloak is open source Apache License 2.0 code.
  * Any IdP software should work in this scenario provided it can execute some custom code on successful authentication that can:
    * Read the TDF Client public key from a custom HTTP header sent with the OIDC authentication request.
    * Construct and send an Attribute Provider web service request, including the public key in the payload.
    * Return the resulting Claims Object in the signed IdP JWT.
  * *Virtru Protocol Mapper* is our Keycloak-specific reference implementation of the above functionality.
* *Attribute Provider* (AP) - A web service that will receive requests from our OIDC IdP custom code (ex: Virtru Protocol Mapper) containing information about authenticated subjet and return our custom OIDC/OAuth claims in response.  It is the responsibility of Attribute Provider to transform 3rd party IdP claims/metadata to ABAC attributes.  It returns a TDF [Claims Object](../schema/ClaimsObject.md).
* *Key Access Service* (KAS) - Responsible for authorizing and granting TDF Clients access to rewrapped data key material. If authorized, TDF Clients can use this rewrapped data key to decrypt TDF ciphertext.  A valid OIDC token containing [TDF Claims](../schema/ClaimsObject.md) must be used as a bearer token when communicating with KAS.  KAS will first verify the authenticity of the bearer token and then the policy claims within that bearer token.  An otherwise valid and trusted OIDC token without valid TDF Claims will be rejected.

## Workflow

The following sequence diagrams illustrate the workflow taken by the client to encrypt or decrypt TDF ciphertext. The canonical TDF architecture supports two modes of operation: _online mode_ and _offline mode_, which have distinct workflows as shown below.

_Online mode_ is the default mode, where the [wrapped data key](../schema/KeyAccessObject.md) and [authorization policy](../schema/PolicyObject.md) for TDF ciphertext is committed to KAS in-band as part of the `encrypt` operation. This means that the `encrypt` will succeed if and only if all resources are prepared to facilitate an immediate decrypt.

_Offline mode_ requires that the TDF Client previously obtained a
valid, signed, long-lived OIDC JWT with embedded Claims Object via
online OIDC authentication.  Or, the TDF Client has otherwise obtained
a valid signed JWT with embedded Claims Object through offline means
(ex: generated by a script using the IdP signing key).  Clients
running in this mode commit the [authorization
policy](../schema/PolicyObject.md) out-of-band, or when decrypt is
first performed. This significantly reduces latency at the cost of a
slightly larger TDF manifest (as the entire wrapped key and policy
information must be included).

### IdP Direct Authentication, Encrypt

![IdP Direct Authentication](../diagrams/OIDC_direct_auth.png)

### IdP Direct Authentication, Decrypt

![IdP Direct Authentication Decrypt](../diagrams/OIDC_direct_auth_decrypt.png)

### IdP Token Exchange, Encrypt

![IdP Token Exchange](../diagrams/OIDC_token_exchange.png)

#### IdP Brokered Authentication, Encrypt

![IdP Brokered Authentication](../diagrams/OIDC_brokered_auth.png)

